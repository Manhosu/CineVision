<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Limpar Uploads Travados - CineVision</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .card {
            background: #2a2a2a;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        h1 {
            color: #60a5fa;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #9ca3af;
            margin-bottom: 30px;
        }
        button {
            background: #dc2626;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-right: 10px;
            transition: background 0.2s;
        }
        button:hover {
            background: #b91c1c;
        }
        button.secondary {
            background: #3b82f6;
        }
        button.secondary:hover {
            background: #2563eb;
        }
        .info-box {
            background: #1e3a8a;
            border-left: 4px solid #60a5fa;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .success-box {
            background: #14532d;
            border-left: 4px solid #22c55e;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .tasks-list {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        .task-item {
            padding: 10px;
            margin: 5px 0;
            background: #2a2a2a;
            border-radius: 4px;
            border-left: 3px solid #60a5fa;
        }
        .task-item.stuck {
            border-left-color: #dc2626;
        }
        pre {
            background: #1a1a1a;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="card">
        <h1>üßπ Limpar Uploads Travados</h1>
        <p class="subtitle">Ferramenta para remover uploads travados do localStorage</p>

        <div class="info-box">
            <strong>‚ÑπÔ∏è Como funciona:</strong><br>
            Esta ferramenta limpa uploads que ficaram travados no localStorage do navegador.
            Isso acontece quando:
            <ul>
                <li>A p√°gina √© recarregada durante um upload</li>
                <li>O navegador √© fechado durante um upload</li>
                <li>Um upload falha mas n√£o √© removido automaticamente</li>
            </ul>
        </div>

        <div id="current-tasks">
            <h3>üìã Uploads Atuais no LocalStorage:</h3>
            <div class="tasks-list" id="tasks-container">
                <p style="color: #9ca3af;">Carregando...</p>
            </div>
        </div>

        <div style="margin-top: 30px;">
            <button onclick="clearAllTasks()">üóëÔ∏è Limpar TODOS os Uploads</button>
            <button onclick="clearStuckUploading()" class="secondary">‚ö†Ô∏è Limpar Apenas Uploads Travados em "uploading"</button>
            <button onclick="location.reload()" class="secondary">üîÑ Recarregar P√°gina</button>
        </div>

        <div id="result" style="margin-top: 20px;"></div>
    </div>

    <script>
        const STORAGE_KEY = 'cinevision_upload_tasks';

        function loadTasks() {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (!stored) {
                    document.getElementById('tasks-container').innerHTML =
                        '<p style="color: #22c55e;">‚úÖ Nenhum upload no localStorage!</p>';
                    return [];
                }

                const tasks = JSON.parse(stored);

                if (tasks.length === 0) {
                    document.getElementById('tasks-container').innerHTML =
                        '<p style="color: #22c55e;">‚úÖ Nenhum upload no localStorage!</p>';
                    return [];
                }

                let html = `<p style="color: #9ca3af; margin-bottom: 10px;">Total: ${tasks.length} upload(s)</p>`;

                tasks.forEach((task, index) => {
                    const isStuck = task.status === 'uploading';
                    const className = isStuck ? 'task-item stuck' : 'task-item';
                    const statusEmoji = {
                        'uploading': '‚è≥',
                        'completed': '‚úÖ',
                        'ready': '‚úÖ',
                        'error': '‚ùå',
                        'cancelled': 'üö´'
                    }[task.status] || '‚ùì';

                    html += `
                        <div class="${className}">
                            <strong>${statusEmoji} ${task.fileName || 'Sem nome'}</strong><br>
                            <small style="color: #9ca3af;">
                                Status: ${task.status} |
                                Progresso: ${task.progress || 0}% |
                                Tipo: ${task.type || 'movie'} |
                                ID: ${task.id}
                            </small>
                            ${task.error ? `<br><small style="color: #dc2626;">Erro: ${task.error}</small>` : ''}
                        </div>
                    `;
                });

                document.getElementById('tasks-container').innerHTML = html;
                return tasks;
            } catch (error) {
                console.error('Erro ao carregar tasks:', error);
                document.getElementById('tasks-container').innerHTML =
                    '<p style="color: #dc2626;">‚ùå Erro ao carregar uploads!</p>';
                return [];
            }
        }

        function clearAllTasks() {
            if (!confirm('‚ö†Ô∏è Tem certeza que deseja limpar TODOS os uploads?\n\nIsso vai remover uploads conclu√≠dos e em andamento.')) {
                return;
            }

            try {
                const tasks = loadTasks();
                localStorage.removeItem(STORAGE_KEY);

                document.getElementById('result').innerHTML = `
                    <div class="success-box">
                        <strong>‚úÖ Sucesso!</strong><br>
                        ${tasks.length} upload(s) foram removidos do localStorage.
                    </div>
                `;

                setTimeout(() => loadTasks(), 500);
            } catch (error) {
                document.getElementById('result').innerHTML = `
                    <div class="info-box" style="background: #7f1d1d; border-left-color: #dc2626;">
                        <strong>‚ùå Erro!</strong><br>
                        ${error.message}
                    </div>
                `;
            }
        }

        function clearStuckUploading() {
            if (!confirm('‚ö†Ô∏è Tem certeza que deseja limpar uploads travados em "uploading"?\n\nApenas uploads com status "uploading" ser√£o removidos.')) {
                return;
            }

            try {
                const tasks = loadTasks();
                const stuckTasks = tasks.filter(t => t.status === 'uploading');
                const cleanTasks = tasks.filter(t => t.status !== 'uploading');

                if (stuckTasks.length === 0) {
                    document.getElementById('result').innerHTML = `
                        <div class="info-box">
                            <strong>‚ÑπÔ∏è Nenhum upload travado!</strong><br>
                            N√£o h√° uploads com status "uploading".
                        </div>
                    `;
                    return;
                }

                localStorage.setItem(STORAGE_KEY, JSON.stringify(cleanTasks));

                document.getElementById('result').innerHTML = `
                    <div class="success-box">
                        <strong>‚úÖ Sucesso!</strong><br>
                        ${stuckTasks.length} upload(s) travado(s) foram removidos.<br>
                        ${cleanTasks.length} upload(s) foram mantidos.
                    </div>
                `;

                setTimeout(() => loadTasks(), 500);
            } catch (error) {
                document.getElementById('result').innerHTML = `
                    <div class="info-box" style="background: #7f1d1d; border-left-color: #dc2626;">
                        <strong>‚ùå Erro!</strong><br>
                        ${error.message}
                    </div>
                `;
            }
        }

        // Carregar tasks ao abrir a p√°gina
        window.addEventListener('DOMContentLoaded', loadTasks);
    </script>
</body>
</html>
